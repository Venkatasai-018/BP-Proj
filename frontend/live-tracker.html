<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå Real-Time College Bus Tracker</title>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
        
        .header { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); 
            color: white; 
            padding: 20px 0; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px;
        }
        
        .header h1 { font-size: 2.5rem; font-weight: 700; }
        .header p { opacity: 0.8; font-size: 1.1rem; margin-top: 5px; }
        
        .live-indicator { 
            display: flex; 
            align-items: center; 
            background: rgba(255,255,255,0.1); 
            padding: 8px 16px; 
            border-radius: 20px; 
        }
        .live-dot { 
            width: 12px; 
            height: 12px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
            margin-right: 8px; 
        }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        /* Statistics Dashboard */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-icon { font-size: 2rem; opacity: 0.8; }
        .stat-number { font-size: 2.8rem; font-weight: 800; margin-bottom: 5px; }
        .stat-label { color: #64748b; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-change { font-size: 0.85rem; margin-top: 8px; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        
        /* Main Layout */
        .main-layout { 
            display: grid; 
            grid-template-columns: 1fr 380px; 
            gap: 30px; 
            margin-bottom: 30px;
        }
        
        .map-section { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            height: 600px;
        }
        
        #busMap { 
            width: 100%; 
            height: 100%; 
        }
        
        .sidebar { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        
        .panel { 
            background: white; 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .panel-title { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #1e293b; 
        }
        
        /* Bus List */
        .bus-grid { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            max-height: 400px; 
            overflow-y: auto; 
        }
        
        .bus-card { 
            padding: 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .bus-card:hover { border-color: #3b82f6; background: #f8fafc; }
        .bus-card.selected { border-color: #3b82f6; background: #eff6ff; }
        .bus-card.moving { border-left: 4px solid #10b981; }
        .bus-card.at-stop { border-left: 4px solid #f59e0b; }
        .bus-card.delayed { border-left: 4px solid #ef4444; }
        
        .bus-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .bus-number { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: #1e293b; 
        }
        
        .bus-status { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }
        .status-moving { background: #dcfce7; color: #166534; }
        .status-at-stop { background: #fef3c7; color: #92400e; }
        .status-delayed { background: #fecaca; color: #991b1b; }
        
        .bus-info { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            font-size: 0.85rem; 
            color: #64748b; 
        }
        
        .progress-container { 
            margin: 10px 0; 
        }
        .progress-bar { 
            width: 100%; 
            height: 6px; 
            background: #e2e8f0; 
            border-radius: 3px; 
            overflow: hidden; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3b82f6, #06b6d4); 
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        .progress-text { 
            font-size: 0.8rem; 
            color: #64748b; 
            margin-top: 4px; 
        }
        
        /* Alerts */
        .alert-item { 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 12px; 
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .alert-warning { background: #fef3c7; border-color: #f59e0b; }
        .alert-critical { background: #fecaca; border-color: #ef4444; }
        .alert-info { background: #dbeafe; border-color: #3b82f6; }
        
        .alert-header { font-weight: 600; margin-bottom: 4px; }
        .alert-time { font-size: 0.8rem; opacity: 0.7; margin-top: 4px; }
        
        /* Connection Status */
        .connection-status { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 12px 20px; 
            border-radius: 25px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            z-index: 1001;
            transition: all 0.3s ease;
        }
        .connected { background: #dcfce7; color: #166534; border: 2px solid #10b981; }
        .disconnected { background: #fecaca; color: #991b1b; border: 2px solid #ef4444; }
        
        /* Controls */
        .controls { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        
        .btn { 
            background: #3b82f6; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: #2563eb; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.secondary { background: #64748b; }
        .btn.secondary:hover { background: #475569; }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .sidebar { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
            .bus-info { grid-template-columns: 1fr; }
        }
        
        /* Loading Animation */
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 200px; 
            color: #64748b; 
        }
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üöå Live College Bus Tracker</h1>
                <p>Real-time Bus Monitoring & Navigation System</p>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
        </div>
    </header>
    
    <div class="connection-status" id="connectionStatus">
        <span id="connectionText">Connecting...</span>
    </div>
    
    <div class="container">
        <!-- Statistics Dashboard -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">üöå</div>
                </div>
                <div class="stat-number" id="activeBuses">0</div>
                <div class="stat-label">Active Buses</div>
                <div class="stat-change positive" id="busChange">+0 from last hour</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">üë•</div>
                </div>
                <div class="stat-number" id="totalPassengers">0</div>
                <div class="stat-label">Total Passengers</div>
                <div class="stat-change" id="passengerChange">Real-time count</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">‚ö°</div>
                </div>
                <div class="stat-number" id="avgSpeed">0</div>
                <div class="stat-label">Avg Speed (km/h)</div>
                <div class="stat-change" id="speedChange">Live monitoring</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                </div>
                <div class="stat-number" id="alertCount">0</div>
                <div class="stat-label">Active Alerts</div>
                <div class="stat-change" id="alertChange">System status</div>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Live Map -->
            <div class="map-section">
                <div id="busMap"></div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Live Bus Updates -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">üöç Live Buses</h3>
                        <select id="filterSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all">All Buses</option>
                            <option value="moving">Moving</option>
                            <option value="at-stop">At Stop</option>
                            <option value="delayed">Delayed</option>
                        </select>
                    </div>
                    <div class="bus-grid" id="busGrid">
                        <div class="loading">Loading bus data...</div>
                    </div>
                </div>
                
                <!-- Alerts Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">üö® Live Alerts</h3>
                        <span id="lastUpdated" style="font-size: 0.8rem; color: #64748b;">Just now</span>
                    </div>
                    <div id="alertsContainer">
                        <div class="loading">Loading alerts...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <a href="/docs" class="btn">üìñ API Docs</a>
            <button class="btn secondary" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">‚è∏Ô∏è Pause Updates</button>
            <button class="btn secondary" onclick="centerMapOnBuses()">üéØ Center Map</button>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        class RealTimeBusTracker {
            constructor() {
                this.websocket = null;
                this.map = null;
                this.busMarkers = {};
                this.routeLines = {};
                this.autoRefresh = true;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.busData = {};
                this.alerts = [];
                this.selectedBus = null;
                this.filterType = 'all';
                
                this.initializeMap();
                this.initializeWebSocket();
                this.setupEventListeners();
                this.startStatusUpdater();
            }
            
            initializeMap() {
                // Initialize map centered on Bangalore (adjust coordinates as needed)
                this.map = L.map('busMap').setView([12.9716, 77.5946], 12);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
                
                // Add map controls
                this.map.on('click', () => {
                    this.selectedBus = null;
                    this.updateBusDisplay();
                });
            }
            
            initializeWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                try {
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        console.log('üîó WebSocket connected successfully');
                        this.updateConnectionStatus(true);
                        this.reconnectAttempts = 0;
                        this.requestAllBuses();
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };
                    
                    this.websocket.onclose = () => {
                        console.log('‚ùå WebSocket disconnected');
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus(false);
                    };
                    
                } catch (error) {
                    console.error('Failed to create WebSocket:', error);
                    this.fallbackToPolling();
                }
            }
            
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'welcome':
                        console.log('üëã Welcome:', data.message);
                        break;
                        
                    case 'live_update':
                        this.busData = data.data || {};
                        this.updateMapMarkers();
                        this.updateBusDisplay();
                        this.updateStatistics(data.statistics);
                        this.updateAlerts(data.alerts);
                        break;
                        
                    case 'bus_update':
                        if (data.bus_id && data.data) {
                            this.busData[data.bus_id] = data.data;
                            this.updateSingleBusMarker(data.bus_id, data.data);
                            this.updateBusDisplay();
                        }
                        break;
                        
                    case 'all_buses':
                        this.busData = data.data || {};
                        this.updateMapMarkers();
                        this.updateBusDisplay();
                        if (data.statistics) {
                            this.updateStatistics(data.statistics);
                        }
                        break;
                        
                    case 'pong':
                        // Heartbeat response
                        break;
                        
                    case 'error':
                        console.error('Server error:', data.message);
                        break;
                }
            }
            
            updateMapMarkers() {
                // Clear existing markers
                Object.values(this.busMarkers).forEach(marker => {
                    this.map.removeLayer(marker);
                });
                this.busMarkers = {};
                
                // Add markers for each bus
                Object.entries(this.busData).forEach(([busId, bus]) => {
                    this.updateSingleBusMarker(parseInt(busId), bus);
                });
                
                // Auto-fit map to show all buses on first load
                if (Object.keys(this.busMarkers).length > 0 && !this.mapInitialized) {
                    this.centerMapOnBuses();
                    this.mapInitialized = true;
                }
            }
            
            updateSingleBusMarker(busId, bus) {
                if (!bus.latitude || !bus.longitude) return;
                
                // Create bus icon based on status
                const iconColor = bus.status === 'moving' ? '#10b981' : 
                                bus.status === 'at_stop' ? '#f59e0b' : '#ef4444';
                
                const busIcon = L.divIcon({
                    html: `<div style="
                        background: ${iconColor};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 14px;
                        color: white;
                        font-weight: bold;
                    ">üöå</div>`,
                    className: 'bus-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                // Create marker
                const marker = L.marker([bus.latitude, bus.longitude], { icon: busIcon })
                    .addTo(this.map);
                
                // Create detailed popup
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">üöå ${bus.bus_number || 'Unknown'}</h3>
                        <div style="display: grid; gap: 5px; font-size: 0.9rem;">
                            <div><strong>Driver:</strong> ${bus.driver_name || 'N/A'}</div>
                            <div><strong>Route:</strong> ${bus.route_name || 'N/A'}</div>
                            <div><strong>Status:</strong> <span style="color: ${iconColor}; font-weight: bold;">${(bus.status || 'unknown').replace('_', ' ').toUpperCase()}</span></div>
                            <div><strong>Speed:</strong> ${Math.round(bus.speed || 0)} km/h</div>
                            <div><strong>Passengers:</strong> ${bus.passengers || 0}/${bus.capacity || 50}</div>
                            <div><strong>Fuel:</strong> ${Math.round(bus.fuel_level || 0)}%</div>
                            <div><strong>Next Stop:</strong> ${bus.next_stop?.name || 'Unknown'}</div>
                            <div><strong>Progress:</strong> ${Math.round(bus.route_progress || 0)}%</div>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                // Handle marker click
                marker.on('click', () => {
                    this.selectedBus = busId;
                    this.updateBusDisplay();
                });
                
                this.busMarkers[busId] = marker;
            }
            
            updateBusDisplay() {
                const container = document.getElementById('busGrid');
                const filteredBuses = this.getFilteredBuses();
                
                if (Object.keys(filteredBuses).length === 0) {
                    container.innerHTML = '<div class="loading">No buses match the current filter</div>';
                    return;
                }
                
                let html = '';
                Object.entries(filteredBuses).forEach(([busId, bus]) => {
                    const isSelected = this.selectedBus == busId;
                    const status = (bus.status || 'unknown').replace('_', '-');
                    const progress = bus.route_progress || 0;
                    const occupancy = bus.capacity ? (bus.passengers / bus.capacity) * 100 : 0;
                    
                    html += `
                        <div class="bus-card ${status} ${isSelected ? 'selected' : ''}" onclick="selectBus(${busId})">
                            <div class="bus-header">
                                <div class="bus-number">üöå ${bus.bus_number || 'Unknown'}</div>
                                <div class="bus-status status-${status}">${(bus.status || 'unknown').replace('_', ' ')}</div>
                            </div>
                            <div class="bus-info">
                                <div>üë®‚Äç‚úàÔ∏è ${bus.driver_name || 'N/A'}</div>
                                <div>üöó ${Math.round(bus.speed || 0)} km/h</div>
                                <div>üë• ${bus.passengers || 0}/${bus.capacity || 50}</div>
                                <div>‚õΩ ${Math.round(bus.fuel_level || 0)}%</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="progress-text">
                                    Route: ${Math.round(progress)}% ‚Ä¢ Next: ${bus.next_stop?.name || 'Unknown'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            getFilteredBuses() {
                if (this.filterType === 'all') {
                    return this.busData;
                }
                
                const filtered = {};
                Object.entries(this.busData).forEach(([busId, bus]) => {
                    if (bus.status === this.filterType.replace('-', '_')) {
                        filtered[busId] = bus;
                    }
                });
                return filtered;
            }
            
            updateStatistics(stats) {
                if (!stats) return;
                
                document.getElementById('activeBuses').textContent = stats.total_active_buses || 0;
                document.getElementById('totalPassengers').textContent = stats.total_passengers || 0;
                document.getElementById('avgSpeed').textContent = Math.round(stats.average_speed || 0);
                
                // Update change indicators
                this.updateChangeIndicators(stats);
            }
            
            updateChangeIndicators(stats) {
                const busChange = document.getElementById('busChange');
                const passengerChange = document.getElementById('passengerChange');
                const speedChange = document.getElementById('speedChange');
                
                busChange.textContent = `${stats.buses_moving || 0} moving, ${stats.buses_at_stops || 0} at stops`;
                passengerChange.textContent = `Avg: ${Math.round(stats.average_fuel_level || 0)}% fuel level`;
                speedChange.textContent = `${stats.buses_moving || 0} buses in motion`;
            }
            
            updateAlerts(alerts) {
                this.alerts = alerts || [];
                document.getElementById('alertCount').textContent = this.alerts.length;
                
                const container = document.getElementById('alertsContainer');
                
                if (this.alerts.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px 20px;">üéâ No alerts - All systems normal</div>';
                    return;
                }
                
                let html = '';
                this.alerts.slice(0, 5).forEach(alert => {  // Show only latest 5 alerts
                    const alertClass = `alert-${alert.severity}`;
                    const icon = alert.severity === 'critical' ? 'üö®' : alert.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    
                    html += `
                        <div class="alert-item ${alertClass}">
                            <div class="alert-header">${icon} ${alert.type.replace('_', ' ').toUpperCase()}</div>
                            <div>${alert.message}</div>
                            <div class="alert-time">${new Date(alert.timestamp).toLocaleTimeString()}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const textEl = document.getElementById('connectionText');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    textEl.textContent = 'üü¢ Connected';
                } else {
                    statusEl.className = 'connection-status disconnected';
                    textEl.textContent = 'üî¥ Disconnected';
                }
            }
            
            setupEventListeners() {
                // Filter dropdown
                document.getElementById('filterSelect').addEventListener('change', (e) => {
                    this.filterType = e.target.value;
                    this.updateBusDisplay();
                });
                
                // Auto-refresh toggle
                document.getElementById('autoRefreshBtn').addEventListener('click', () => {
                    this.toggleAutoRefresh();
                });
            }
            
            startStatusUpdater() {
                setInterval(() => {
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                }, 1000);
            }
            
            requestAllBuses() {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify({ type: 'get_all_buses' }));
                }
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts && this.autoRefresh) {
                    this.reconnectAttempts++;
                    console.log(`üîÑ Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    setTimeout(() => this.initializeWebSocket(), 2000 * this.reconnectAttempts);
                } else {
                    console.log('‚ö†Ô∏è Max reconnection attempts reached, falling back to polling');
                    this.fallbackToPolling();
                }
            }
            
            fallbackToPolling() {
                console.log('üìä Using HTTP polling as fallback');
                
                const poll = () => {
                    if (this.autoRefresh) {
                        fetch('/live/buses')
                            .then(response => response.json())
                            .then(data => {
                                this.busData = data.buses || {};
                                this.updateMapMarkers();
                                this.updateBusDisplay();
                                
                                if (data.statistics) {
                                    this.updateStatistics(data.statistics);
                                }
                            })
                            .catch(error => console.error('Polling error:', error));
                    }
                    setTimeout(poll, 10000); // Poll every 10 seconds
                };
                
                poll();
            }
            
            toggleAutoRefresh() {
                this.autoRefresh = !this.autoRefresh;
                const btn = document.getElementById('autoRefreshBtn');
                btn.innerHTML = this.autoRefresh ? '‚è∏Ô∏è Pause Updates' : '‚ñ∂Ô∏è Resume Updates';
                
                if (!this.autoRefresh && this.websocket) {
                    this.websocket.close();
                } else if (this.autoRefresh && (!this.websocket || this.websocket.readyState !== WebSocket.OPEN)) {
                    this.initializeWebSocket();
                }
            }
            
            centerMapOnBuses() {
                const busPositions = Object.values(this.busData)
                    .filter(bus => bus.latitude && bus.longitude)
                    .map(bus => [bus.latitude, bus.longitude]);
                
                if (busPositions.length > 0) {
                    const group = new L.featureGroup(Object.values(this.busMarkers));
                    this.map.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }
        
        // Global functions
        function selectBus(busId) {
            if (window.tracker) {
                window.tracker.selectedBus = window.tracker.selectedBus === busId ? null : busId;
                window.tracker.updateBusDisplay();
                
                // Center map on selected bus
                if (window.tracker.selectedBus && window.tracker.busMarkers[busId]) {
                    const marker = window.tracker.busMarkers[busId];
                    window.tracker.map.setView(marker.getLatLng(), 15);
                    marker.openPopup();
                }
            }
        }
        
        function refreshData() {
            if (window.tracker) {
                window.tracker.requestAllBuses();
                
                // Also refresh alerts
                fetch('/live/alerts')
                    .then(response => response.json())
                    .then(data => {
                        window.tracker.updateAlerts(data.alerts);
                    })
                    .catch(error => console.error('Error refreshing alerts:', error));
            }
        }
        
        function toggleAutoRefresh() {
            if (window.tracker) {
                window.tracker.toggleAutoRefresh();
            }
        }
        
        function centerMapOnBuses() {
            if (window.tracker) {
                window.tracker.centerMapOnBuses();
            }
        }
        
        // Initialize the tracker when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.tracker = new RealTimeBusTracker();
            
            // Load initial statistics
            fetch('/live/statistics')
                .then(response => response.json())
                .then(data => {
                    window.tracker.updateStatistics(data);
                })
                .catch(error => console.error('Error loading initial stats:', error));
        });
    </script>
</body>
</html>